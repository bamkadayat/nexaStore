generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * USER & AUTHENTICATION
 */

model User {
  id            String  @id @default(uuid())
  email         String  @unique
  password      String
  name          String
  role          Role    @default(USER)
  emailVerified Boolean @default(false)
  isActive      Boolean @default(true)

  // Relations
  cart      Cart?
  orders    Order[]
  addresses Address[]
  reviews   Review[]
  wishlist  Wishlist?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  @@index([email])
  @@map("users")
}

/**
 * USER ROLE
 */
enum Role {
  USER
  ADMIN
}

/**
 * PRODUCTS
 */
model Product {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  description  String   @db.Text
  price        Decimal  @db.Decimal(10, 2)
  comparePrice Decimal? @db.Decimal(10, 2) // Original price for discounts
  costPrice    Decimal? @db.Decimal(10, 2) // For profit calculations
  sku          String?  @unique
  barcode      String?

  // Inventory
  stock             Int     @default(0)
  lowStockThreshold Int     @default(10)
  trackInventory    Boolean @default(true)

  // Categorization
  category String
  brand    String?
  tags     String[]

  // Media
  images    String[] // Array of image URLs
  thumbnail String? // Main thumbnail

  // SEO
  metaTitle       String?
  metaDescription String?

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Relations
  cartItems     CartItem[]
  orderItems    OrderItem[]
  reviews       Review[]
  wishlistItems WishlistItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([slug])
  @@index([name])
  @@index([isActive, isFeatured])
  @@map("products")
}

/**
 * CART
 */
model Cart {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  items CartItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("carts")
}

/**
 * CART ITEMS
 */
model CartItem {
  id        String  @id @default(uuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int     @default(1)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

/**
 * ORDERS
 */
model Order {
  id          String @id @default(uuid())
  orderNumber String @unique
  userId      String
  user        User   @relation(fields: [userId], references: [id])

  // Order Details
  items        OrderItem[]
  subtotal     Decimal     @db.Decimal(10, 2)
  tax          Decimal     @default(0) @db.Decimal(10, 2)
  shippingCost Decimal     @default(0) @db.Decimal(10, 2)
  discount     Decimal     @default(0) @db.Decimal(10, 2)
  total        Decimal     @db.Decimal(10, 2)

  // Status
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  // Payment
  paymentMethod   String? // card, bank_transfer, etc.
  paymentIntentId String? @unique // Stripe payment intent ID

  // Shipping
  shippingAddress Json // Store as JSON for flexibility
  billingAddress  Json? // Optional separate billing address
  trackingNumber  String?
  shippingCarrier String?

  // Notes
  customerNote String? @db.Text
  internalNote String? @db.Text // Admin notes

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  paidAt      DateTime?
  shippedAt   DateTime?
  deliveredAt DateTime?
  cancelledAt DateTime?

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

enum OrderStatus {
  PENDING // Order created, awaiting payment
  PAID // Payment received
  PROCESSING // Order being prepared
  SHIPPED // Order shipped
  DELIVERED // Order delivered
  CANCELLED // Order cancelled
  REFUNDED // Order refunded
}

enum PaymentStatus {
  PENDING // Awaiting payment
  PAID // Payment successful
  FAILED // Payment failed
  REFUNDED // Payment refunded
  PARTIALLY_REFUNDED // Partial refund
}

/**
 * ORDER ITEMS
 */
model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Snapshot of product at time of order
  productName  String
  productImage String?
  sku          String?

  // Pricing
  quantity Int
  price    Decimal @db.Decimal(10, 2) // Price at time of order
  subtotal Decimal @db.Decimal(10, 2) // quantity * price

  // Timestamps
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

/**
 * ADDRESSES
 */
model Address {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Address fields
  fullName     String
  company      String?
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  country      String  @default("Norway")
  phone        String

  // Flags
  isDefault Boolean     @default(false)
  type      AddressType @default(SHIPPING)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("addresses")
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

/**
 * REVIEWS
 */
model Review {
  id        String  @id @default(uuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Review content
  rating  Int // 1-5 stars
  title   String?
  comment String  @db.Text

  // Status
  isVerifiedPurchase Boolean @default(false)
  isApproved         Boolean @default(false) // Admin approval

  // Helpful votes
  helpfulCount Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId]) // One review per user per product
  @@index([productId])
  @@index([rating])
  @@map("reviews")
}

/**
 * WISHLIST
 */
model Wishlist {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  items WishlistItem[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("wishlists")
}

/**
 * WISHLIST ITEMS
 */
model WishlistItem {
  id         String   @id @default(uuid())
  wishlistId String
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([wishlistId, productId])
  @@index([wishlistId])
  @@index([productId])
  @@map("wishlist_items")
}

/**
 * CATEGORIES
 */
model Category {
  id          String     @id @default(uuid())
  name        String     @unique
  slug        String     @unique
  description String?    @db.Text
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")

  // SEO
  metaTitle       String?
  metaDescription String?

  // Display
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}
